import{_ as te,u as ae,r as f,ag as ie,v as se,M as le,c as S,w as a,P as ne,O as k,a as re,o as P,b as t,V as oe,y as C,f as w,g as _,h as r,T as E,U as A,X as x,t as h,Y as D,R as ue,p as v,ab as ce,B as W,q as I,i as F,m as L,ah as de,s as M,$ as ve,l as K,ai as fe,aj as ge,ak as me,a2 as pe,a4 as R}from"./index-D2XvMCja.js";const he={class:"d-flex ga-2 flex-wrap"},be={class:"text-caption",style:{"white-space":"pre-wrap","word-break":"break-all","max-height":"200px","overflow-y":"auto"}},ke={__name:"SettingsViewNew",setup(ye){const q=re(),d=ae(),b=f({notification_time:"09:00",digest_filter:"overdue_and_today"}),o=f(!1),u=f(""),c=f("success"),y=f(!1),V=f(!1),p=f({first_name:"",last_name:""}),g=f(!1),z=f(!1),B=f(""),i=ie({serviceWorker:!1,serviceWorkerDetails:"Prüfung...",notificationPermission:"default",pushSubscription:!1,pushSubscriptionDetails:"Prüfung...",vapidKey:!1,vapidKeyDetails:"Prüfung..."});function l(s){const e=new Date().toLocaleTimeString();B.value=`[${e}] ${s}
${B.value}`}async function N(){var s;g.value=!0,B.value="",l("Starte Status-Prüfung...");try{if("serviceWorker"in navigator){l("Service Worker API verfügbar");const e=await navigator.serviceWorker.getRegistration();e?(i.serviceWorker=!0,i.serviceWorkerDetails=`Aktiv (Scope: ${e.scope})`,l(`Service Worker registriert: ${e.scope}`),l(`SW State: ${((s=e.active)==null?void 0:s.state)||"unbekannt"}`)):(i.serviceWorker=!1,i.serviceWorkerDetails="Nicht registriert",l("Kein Service Worker registriert"))}else i.serviceWorker=!1,i.serviceWorkerDetails="Nicht unterstützt",l("Service Worker nicht unterstützt");if("Notification"in window?(i.notificationPermission=Notification.permission,l(`Benachrichtigungs-Berechtigung: ${Notification.permission}`)):(i.notificationPermission="nicht unterstützt",l("Notification API nicht unterstützt")),"serviceWorker"in navigator&&"PushManager"in window){l("PushManager API verfügbar");const e=await navigator.serviceWorker.getRegistration();if(e){const n=await e.pushManager.getSubscription();n?(i.pushSubscription=!0,i.pushSubscriptionDetails=`Aktiv (Endpoint: ${n.endpoint.substring(0,50)}...)`,l("Push-Abonnement aktiv"),l(`Endpoint: ${n.endpoint}`)):(i.pushSubscription=!1,i.pushSubscriptionDetails="Nicht abonniert",l("Kein Push-Abonnement vorhanden"))}}else i.pushSubscription=!1,i.pushSubscriptionDetails="Nicht unterstützt",l("PushManager nicht unterstützt");try{const e=await k.get("/push/vapid-public-key");e.vapidPublicKey?(i.vapidKey=!0,i.vapidKeyDetails=`Verfügbar (${e.vapidPublicKey.substring(0,20)}...)`,l("VAPID-Schlüssel vom Server erhalten")):(i.vapidKey=!1,i.vapidKeyDetails="Nicht konfiguriert",l("VAPID-Schlüssel nicht konfiguriert"))}catch(e){i.vapidKey=!1,i.vapidKeyDetails=`Fehler: ${e.message}`,l(`VAPID-Fehler: ${e.message}`)}l("Status-Prüfung abgeschlossen")}catch(e){l(`Fehler: ${e.message}`)}finally{g.value=!1}}async function O(){l("Fordere Benachrichtigungs-Berechtigung an...");try{const s=await Notification.requestPermission();i.notificationPermission=s,l(`Berechtigung: ${s}`),s==="granted"?(u.value="Berechtigung erteilt",c.value="success"):(u.value="Berechtigung verweigert",c.value="warning"),o.value=!0}catch(s){l(`Fehler: ${s.message}`),u.value="Fehler beim Anfordern",c.value="error",o.value=!0}}async function j(){g.value=!0,l("Starte Push-Abonnement...");try{const{vapidPublicKey:s}=await k.get("/push/vapid-public-key");l("VAPID-Schlüssel erhalten");const e=await navigator.serviceWorker.ready;l("Service Worker bereit");const n=X(s),m=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n});l("Push-Abonnement erstellt"),l(`Endpoint: ${m.endpoint}`),await k.post("/push/subscribe",m.toJSON()),l("Abonnement an Server gesendet"),await N(),u.value="Push aktiviert",c.value="success",o.value=!0}catch(s){l(`Fehler: ${s.message}`),u.value="Fehler beim Aktivieren",c.value="error",o.value=!0}finally{g.value=!1}}async function Z(){g.value=!0,l("Deaktiviere Push...");try{const s=await navigator.serviceWorker.getRegistration();if(s){const e=await s.pushManager.getSubscription();e&&(await e.unsubscribe(),l("Lokal abgemeldet"),await k.delete("/push/subscribe"),l("Vom Server entfernt"))}await N(),u.value="Push deaktiviert",c.value="success",o.value=!0}catch(s){l(`Fehler: ${s.message}`),u.value="Fehler beim Deaktivieren",c.value="error",o.value=!0}finally{g.value=!1}}async function J(){z.value=!0,l("Sende Test-Benachrichtigung...");try{await k.post("/push/test"),l("Test-Benachrichtigung gesendet"),u.value="Test gesendet",c.value="success",o.value=!0}catch(s){l(`Fehler: ${s.message}`),u.value="Fehler beim Senden",c.value="error",o.value=!0}finally{z.value=!1}}function X(s){const e="=".repeat((4-s.length%4)%4),n=(s+e).replace(/-/g,"+").replace(/_/g,"/"),m=window.atob(n),U=new Uint8Array(m.length);for(let $=0;$<m.length;++$)U[$]=m.charCodeAt($);return U}const Y=se(()=>{var n,m;const s=((n=d.user)==null?void 0:n.first_name)||"",e=((m=d.user)==null?void 0:m.last_name)||"";return[s,e].filter(Boolean).join(" ")});le(async()=>{d.user&&(b.value.notification_time=d.user.notification_time||"09:00",b.value.digest_filter=d.user.digest_filter||"overdue_and_today"),await N()});async function T(){try{const s=await k.patch("/users/settings",b.value);d.user=s.user,u.value="Einstellungen gespeichert",c.value="success",o.value=!0}catch(s){console.error("Failed to save settings:",s),u.value="Fehler beim Speichern",c.value="error",o.value=!0}}function G(){var s,e;p.value.first_name=((s=d.user)==null?void 0:s.first_name)||"",p.value.last_name=((e=d.user)==null?void 0:e.last_name)||"",V.value=!0}async function H(){try{const s=await k.patch("/users/settings",{first_name:p.value.first_name,last_name:p.value.last_name});d.user=s.user,V.value=!1,u.value="Profil gespeichert",c.value="success",o.value=!0}catch(s){console.error("Failed to save profile:",s),u.value="Fehler beim Speichern",c.value="error",o.value=!0}}function Q(){y.value=!0}async function ee(){y.value=!1,await d.logout(),q.push("/login")}return(s,e)=>(P(),S(ne,{class:"bg-background"},{default:a(()=>[t(oe,{fluid:"",class:"pa-4"},{default:a(()=>[e[21]||(e[21]=C("h1",{class:"text-h5 font-weight-bold mb-4"},"Einstellungen",-1)),t(w,{variant:"outlined",class:"mb-3"},{default:a(()=>[t(_,{class:"text-subtitle-1"},{default:a(()=>[...e[9]||(e[9]=[r("Konto",-1)])]),_:1}),t(E,{class:"pa-0"},{default:a(()=>[t(A,null,{prepend:a(()=>[t(ce,{color:"primary",size:"48"},{default:a(()=>[t(W,{icon:"mdi-account",size:"24"})]),_:1})]),append:a(()=>[t(v,{icon:"mdi-pencil",variant:"text",size:"small",onClick:G})]),default:a(()=>[t(x,{class:"font-weight-medium"},{default:a(()=>[r(h(Y.value||"Kein Name"),1)]),_:1}),t(D,null,{default:a(()=>{var n;return[r(h((n=ue(d).user)==null?void 0:n.email),1)]}),_:1})]),_:1})]),_:1}),t(I,null,{default:a(()=>[t(v,{block:"",variant:"text",color:"error",onClick:Q},{default:a(()=>[...e[10]||(e[10]=[r("Abmelden",-1)])]),_:1})]),_:1})]),_:1}),t(w,{variant:"outlined",class:"mb-3"},{default:a(()=>[t(_,{class:"text-subtitle-1"},{default:a(()=>[...e[11]||(e[11]=[r("Benachrichtigungen",-1)])]),_:1}),t(F,null,{default:a(()=>[t(L,{modelValue:b.value.notification_time,"onUpdate:modelValue":e[0]||(e[0]=n=>b.value.notification_time=n),label:"Tägliche Benachrichtigungszeit",type:"time",variant:"outlined",density:"compact","hide-details":"auto",hint:"Uhrzeit für tägliche Zusammenfassung","persistent-hint":"",onBlur:T,onChange:T},null,8,["modelValue"]),t(de,{modelValue:b.value.digest_filter,"onUpdate:modelValue":[e[1]||(e[1]=n=>b.value.digest_filter=n),T],items:[{value:"all",title:"Alle Aufgaben"},{value:"today_only",title:"Nur heute fällige Aufgaben"},{value:"overdue_and_today",title:"Überfällige und heute fällige Aufgaben"}],label:"Zusammenfassung anzeigen",variant:"outlined",density:"compact","hide-details":"",class:"mt-3"},null,8,["modelValue"])]),_:1})]),_:1}),t(w,{variant:"outlined",class:"mb-3"},{default:a(()=>[t(_,{class:"d-flex align-center"},{default:a(()=>[e[12]||(e[12]=C("span",{class:"text-subtitle-1"},"Push-Benachrichtigungen",-1)),t(M),t(v,{icon:"mdi-refresh",size:"small",variant:"text",onClick:N,loading:g.value},null,8,["loading"])]),_:1}),t(F,null,{default:a(()=>[t(E,{density:"compact",class:"pa-0"},{default:a(()=>[t(A,null,{prepend:a(()=>[t(W,{icon:i.serviceWorker?"mdi-check-circle":"mdi-close-circle",color:i.serviceWorker?"success":"error"},null,8,["icon","color"])]),default:a(()=>[t(x,null,{default:a(()=>[...e[13]||(e[13]=[r("Service Worker",-1)])]),_:1}),t(D,null,{default:a(()=>[r(h(i.serviceWorkerDetails),1)]),_:1})]),_:1}),t(A,null,{prepend:a(()=>[t(W,{icon:i.notificationPermission==="granted"?"mdi-check-circle":i.notificationPermission==="denied"?"mdi-close-circle":"mdi-help-circle",color:i.notificationPermission==="granted"?"success":i.notificationPermission==="denied"?"error":"warning"},null,8,["icon","color"])]),default:a(()=>[t(x,null,{default:a(()=>[...e[14]||(e[14]=[r("Benachrichtigungs-Berechtigung",-1)])]),_:1}),t(D,null,{default:a(()=>[r(h(i.notificationPermission),1)]),_:1})]),_:1}),t(A,null,{prepend:a(()=>[t(W,{icon:i.pushSubscription?"mdi-check-circle":"mdi-close-circle",color:i.pushSubscription?"success":"error"},null,8,["icon","color"])]),default:a(()=>[t(x,null,{default:a(()=>[...e[15]||(e[15]=[r("Push-Abonnement",-1)])]),_:1}),t(D,null,{default:a(()=>[r(h(i.pushSubscriptionDetails),1)]),_:1})]),_:1}),t(A,null,{prepend:a(()=>[t(W,{icon:i.vapidKey?"mdi-check-circle":"mdi-close-circle",color:i.vapidKey?"success":"error"},null,8,["icon","color"])]),default:a(()=>[t(x,null,{default:a(()=>[...e[16]||(e[16]=[r("VAPID-Schlüssel",-1)])]),_:1}),t(D,null,{default:a(()=>[r(h(i.vapidKeyDetails),1)]),_:1})]),_:1})]),_:1}),t(ve,{class:"my-3"}),C("div",he,[i.notificationPermission!=="granted"?(P(),S(v,{key:0,variant:"outlined",size:"small",onClick:O},{default:a(()=>[...e[17]||(e[17]=[r(" Berechtigung anfragen ",-1)])]),_:1})):K("",!0),i.notificationPermission==="granted"&&!i.pushSubscription?(P(),S(v,{key:1,variant:"outlined",size:"small",color:"primary",onClick:j,loading:g.value},{default:a(()=>[...e[18]||(e[18]=[r(" Push aktivieren ",-1)])]),_:1},8,["loading"])):K("",!0),i.pushSubscription?(P(),S(v,{key:2,variant:"outlined",size:"small",color:"error",onClick:Z,loading:g.value},{default:a(()=>[...e[19]||(e[19]=[r(" Push deaktivieren ",-1)])]),_:1},8,["loading"])):K("",!0),i.pushSubscription?(P(),S(v,{key:3,variant:"outlined",size:"small",onClick:J,loading:z.value},{default:a(()=>[...e[20]||(e[20]=[r(" Test senden ",-1)])]),_:1},8,["loading"])):K("",!0)]),t(fe,{class:"mt-3"},{default:a(()=>[t(ge,{title:"Debug-Log"},{default:a(()=>[t(me,null,{default:a(()=>[C("pre",be,h(B.value),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(pe,{modelValue:o.value,"onUpdate:modelValue":e[2]||(e[2]=n=>o.value=n),color:c.value,timeout:2e3},{default:a(()=>[r(h(u.value),1)]),_:1},8,["modelValue","color"])]),_:1}),t(R,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=n=>V.value=n),"max-width":"400"},{default:a(()=>[t(w,null,{default:a(()=>[t(_,{class:"text-h6"},{default:a(()=>[...e[22]||(e[22]=[r("Profil bearbeiten",-1)])]),_:1}),t(F,null,{default:a(()=>[t(L,{modelValue:p.value.first_name,"onUpdate:modelValue":e[3]||(e[3]=n=>p.value.first_name=n),label:"Vorname",variant:"outlined",density:"compact","hide-details":"",class:"mb-3"},null,8,["modelValue"]),t(L,{modelValue:p.value.last_name,"onUpdate:modelValue":e[4]||(e[4]=n=>p.value.last_name=n),label:"Nachname",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])]),_:1}),t(I,null,{default:a(()=>[t(v,{variant:"text",onClick:e[5]||(e[5]=n=>V.value=!1)},{default:a(()=>[...e[23]||(e[23]=[r("Abbrechen",-1)])]),_:1}),t(M),t(v,{variant:"text",color:"primary",onClick:H},{default:a(()=>[...e[24]||(e[24]=[r("Speichern",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:y.value,"onUpdate:modelValue":e[8]||(e[8]=n=>y.value=n),"max-width":"400"},{default:a(()=>[t(w,null,{default:a(()=>[t(_,{class:"text-h6"},{default:a(()=>[...e[25]||(e[25]=[r("Abmelden?",-1)])]),_:1}),t(F,null,{default:a(()=>[...e[26]||(e[26]=[r(" Möchten Sie sich wirklich abmelden? ",-1)])]),_:1}),t(I,null,{default:a(()=>[t(M),t(v,{variant:"text",onClick:e[7]||(e[7]=n=>y.value=!1)},{default:a(()=>[...e[27]||(e[27]=[r("Abbrechen",-1)])]),_:1}),t(v,{variant:"text",color:"error",onClick:ee},{default:a(()=>[...e[28]||(e[28]=[r("Abmelden",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},Se=te(ke,[["__scopeId","data-v-49b98159"]]);export{Se as default};
